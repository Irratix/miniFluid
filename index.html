<!doctype html>
<font face=calibri>
<h2>MiniFluid</h2>
<p>a micro fluid simulation inspired by <a href="https://www.ioccc.org/2012/endoh1/hint.html">endoh1.c</a> and its TS port <a href="https://github.com/phiresky/endoh1-ts">endoh1-ts</a>
<p><canvas id=c style="width:400px;height:300px"></canvas>
<p>Input:
<p><textarea id="pre" cols=80 rows=25></textarea>

<script>
A = 1;  // accuracy
G = .8; // gravity
P = 3;  // pressure
V = 4;  // viscosity
w = 79 * A;
h = 25 * A;

function particle(x, y, w){
  this.x = x;
  this.y = y;
  this.w = w;
  this.vx = 0; // velocity
  this.vy = 0;
  this.fx = 0; // force
  this.fy = 0;
  this.d = 0; // density
}

a = [];
c.width = w * 2;
c.height = h * 2;
ctx = c.getContext('2d');
pre.cols = w;
pre.rows = h;

density = () => {
  
}

nextframe = () => {

  // density
  for(_i = 0; _i < a.length; _i++){
    p = a[_i];
    p.d = p.w ? 9 : 0;
    for(_a = 0; _a < a.length; _a++){
      q = a[_a];
      dx = p.x - q.x, dy = p.y - q.y;
      d2 = dx * dx + dy * dy;
      if(d2 < 4) {
        w_1 = Math.sqrt(d2) / 2 - 1;
        p.d += w_1 * w_1;
      }
    }
  }
  
  // force
  for(_i = 0; _i < a.length; _i++){
    p = a[_i];
    p.fy = G;
    p.fx = 0;
    for(_a = 0; _a < a.length; _a++){
      q = a[_a];
      dy = p.y - q.y, dx = p.x - q.x;
      d2 = dy * dy + dx * dx;
      if(d2 < 4){
        w_2 = Math.sqrt(d2) / 2 - 1;
        p.fy += (dy * (3 - p.d - q.d) * P + p.vy * V - q.vy * V) * w_2 / p.d;
        p.fx += (dx * (3 - p.d - q.d) * P + p.vx * V - q.vx * V) * w_2 / p.d;
      }
    }
  }
  
  // draw
  c.width ^= 0;
  ctx.fillStyle="#0008";
  for(_i = 0; _i < a.length; _i++){
    p = a[_i];
    x = p.x, y = p.y;
    if(!p.w){
      p.y += p.vy += p.fy / 10;
      p.x += p.vx += p.fx / 10;
    }
    if(0 <= x && x < w && 0 <= y && y < h){
      ctx.beginPath();
      ctx.arc(x * 2, y * 2, 2, 0, 7);
      ctx.fill();
    }
  }
}

fetch("inputs/glass-half-empty.txt").then(x=>x.text()).then(v=>{

  // UI
  pre.value = v;
  
  // init
  a = [];
  input = pre.value;
  y = 0, x = 0;
  for(i = 0; i < input.length; i++){
    C = input[i];
    if(C === '\n'){
      y += A;
      x = 0;
    }
    else if(C !== ' '){
      wall = C === '#';
      for(dx = 0; dx < A; dx++)
        for(dy = 0; dy < A; dy++)
          a.push(new particle(x + dx, y + dy, wall));
      x += A;
    }
    else {
      x += A;
    }
  }
  
  // loop
  setInterval(nextframe, 33);
})
</script>