<!doctype html>
<h2>MiniFluid</h2>
<p>a micro fluid simulation inspired by <a href="https://www.ioccc.org/2012/endoh1/hint.html">endoh1.c</a> and its TS port <a href="https://github.com/phiresky/endoh1-ts">endoh1-ts</a>
<p><canvas id="canvas" style="width:400px;height:300px"></canvas>
<p>Input:
<p><textarea id="previewarea" cols=80 rows=25></textarea>

<script>
var accuracy = 1;
var Gravity = 1;
var Pressure = 3;
var Viscosity = 4;
var w = 79 * accuracy;
var h = 25 * accuracy;
var scale = 2;

var a = [];
canvas.width = w * scale;
canvas.height = h * scale;
var ctx = canvas.getContext('2d');
var interval;
previewarea.cols = w;
previewarea.rows = h;

init = () => {
  a = [];
  var input = previewarea.value;
  var y = 0, x = 0;
  for (var i = 0; i < input.length; i++) {
    var c = input[i];
    if (c === '\n') {
      y += accuracy;
      x = 0;
    }
    else if (c !== ' ') {
      var wall = c === '#';
      for (var dx = 0; dx < accuracy; dx++)
        for (var dy = 0; dy < accuracy; dy++)
          a.push({
            posx: x + dx,
            posy: y + dy,
            wallflag: wall,
            velx: 0,
            vely: 0,
            forcex: 0,
            forcey: 0,
            density: 0
          });
      x += accuracy;
    }
    else {
      x += accuracy;
    }
  }
}

density = () => {
  for (var _i = 0; _i < a.length; _i++) {
    var p = a[_i];
    p.density = p.wallflag ? 9 : 0;
    for (var _a = 0; _a < a.length; _a++) {
      var q = a[_a];
      var dx = p.posx - q.posx, dy = p.posy - q.posy;
      var d2 = dx * dx + dy * dy;
      if (d2 < 4) {
        var w_1 = Math.sqrt(d2) / 2 - 1;
        p.density += w_1 * w_1;
      }
    }
  }
}

force = () => {
  for (var _i = 0; _i < a.length; _i++) {
    var p = a[_i];
    p.forcey = Gravity;
    p.forcex = 0;
    for (var _a = 0; _a < a.length; _a++) {
      var q = a[_a];
      var dy = p.posy - q.posy, dx = p.posx - q.posx;
      var d2 = dy * dy + dx * dx;
      if (d2 < 4) {
        var w_2 = Math.sqrt(d2) / 2 - 1;
        p.forcey += (dy * (3 - p.density - q.density) * Pressure + p.vely * Viscosity - q.vely * Viscosity) * w_2 / p.density;
        p.forcex += (dx * (3 - p.density - q.density) * Pressure + p.velx * Viscosity - q.velx * Viscosity) * w_2 / p.density;
      }
    }
  }
}

draw = () => {
  canvas.width ^= 0;
  ctx.fillStyle="#0008";
  for (var _i = 0; _i < a.length; _i++) {
    var p = a[_i];
    var x = p.posx, y = p.posy;
    if (!p.wallflag) {
      p.posy += p.vely += p.forcey / 10;
      p.posx += p.velx += p.forcex / 10;
    }
    if (0 <= x && x < w && 0 <= y && y < h) {
      ctx.beginPath();
      ctx.arc(x * scale, y * scale, scale, 0, 7);
      ctx.fill();
    }
  }
}

nextframe = () => {
  density();
  force();
  draw();
}

fetch("inputs/endoh1.c").then(x=>x.text()).then(v=>{
  previewarea.value = v;
  init();
  setInterval(nextframe, 33);
})
</script>