<!doctype html>
<h2>MiniFluid</h2>
<p>a micro fluid simulation inspired by <a href="https://www.ioccc.org/2012/endoh1/hint.html">endoh1.c</a> and its TS port <a href="https://github.com/phiresky/endoh1-ts">endoh1-ts</a>
<p><canvas id="c" style="width:400px;height:300px"></canvas>
<p>Input:
<p><textarea id="p" cols=80 rows=25></textarea>

<script>
var Gravity = 1;
var Pressure = 3;
var Viscosity = 4;
var w = 79;
var h = 25;
var scale = 2;

var a = [];
c.width = w * scale;
c.height = h * scale;
var ctx = c.getContext('2d');
var interval;

init = () => {
  a = [];
  var input = p.value;
  var y = 0, x = 0;
  for (var i = 0; i < input.length; i++) {
    var c = input[i];
    if (c === '\n') {
      y ++;
      x = 0;
    }
    else if (c !== ' ') {
      var w = c === '#';
      a.push({
        x, // x
        y, // y
        w, // wallflag
        u: 0, // u
        v: 0, // v
        f: 0, // f
        g: 0, // g
        d: 0 // d
      });
      x ++;
    }
    else {
      x ++;
    }
  }
}




fetch("inputs/endoh1.c").then(x=>x.text()).then(v=>{
  p.value = v;
  init();
  setInterval(() => {

    for (var _i = 0; _i < a.length; _i++) {
      var p = a[_i];
      p.d = p.w ? 9 : 0;
      for (var _a = 0; _a < a.length; _a++) {
        var q = a[_a];
        var dx = p.x - q.x, dy = p.y - q.y;
        var d2 = dx * dx + dy * dy;
        if (d2 < 4) {
          var w_1 = Math.sqrt(d2) / 2 - 1;
          p.d += w_1 * w_1;
        }
      }
    }

    // force

    for (var _i = 0; _i < a.length; _i++) {
      var p = a[_i];
      p.g = Gravity;
      p.f = 0;
      for (var _a = 0; _a < a.length; _a++) {
        var q = a[_a];
        var dy = p.y - q.y, dx = p.x - q.x;
        var d2 = dy * dy + dx * dx;
        if (d2 < 4) {
          var w_2 = Math.sqrt(d2) / 2 - 1;
          p.g += (dy * (3 - p.d - q.d) * Pressure + p.v * Viscosity - q.v * Viscosity) * w_2 / p.d;
          p.f += (dx * (3 - p.d - q.d) * Pressure + p.u * Viscosity - q.u * Viscosity) * w_2 / p.d;
        }
      }
    }

    // draw

    c.width ^= 0;
    ctx.fillStyle="#0008";
    for (var _i = 0; _i < a.length; _i++) {
      var p = a[_i];
      var x = p.x, y = p.y;
      if (!p.w) {
        p.y += p.v += p.g / 10;
        p.x += p.u += p.f / 10;
      }
      if (0 <= x && x < w && 0 <= y && y < h) {
        ctx.beginPath();
        ctx.arc(x * scale, y * scale, scale, 0, 7);
        ctx.fill();
      }
    }
  }, 33);
})
</script>